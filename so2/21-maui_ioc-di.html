<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Maui - Inversion of Control &amp; Dependency Injection :: Softwareontwerp 2 (BETA)</title>
    <meta name="generator" content="Antora 3.1.14">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="#">Softwareontwerp 2 (BETA)</a>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
      
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
          <div class="navbar-item has-dropdown is-hoverable">
              <a class="navbar-link" href="#">Producten</a>
              <div class="navbar-dropdown">
                  <a class="navbar-item" target="_blank" href="https://learn.microsoft.com/en-us/cli/azure/">Azure CLI</a>
                  <a class="navbar-item" target="_blank" href="https://www.docker.com/products/docker-desktop">Docker Desktop</a>
                  <a class="navbar-item" target="_blank" href="https://desktop.github.com/download">GitHub Desktop</a>
                  <a class="navbar-item" target="_blank" href="https://www.mysql.com/products/workbench">MySQL Workbench</a>
                  <a class="navbar-item" target="_blank" href="https://www.postman.com/downloads/">Postman</a>
                  <a class="navbar-item" target="_blank" href="https://www.jetbrains.com/rider/download">Rider</a>
                  <a class="navbar-item" target="_blank" href="https://code.visualstudio.com/download">VS Code</a>
              </div>
          </div>
          <div class="navbar-item has-dropdown is-hoverable">
              <a class="navbar-link" href="#">Diensten</a>
              <div class="navbar-dropdown">
                  <a class="navbar-item" target="_blank" href="https://dev.azure.com/hogent-web4-stefancourteaux/">Azure DevOps</a>
                  <a class="navbar-item" target="_blank" href="https://portal.azure.com">Azure Portal</a>
                  <a class="navbar-item" target="_blank" href="https://chamilo.hogent.be">Chamilo</a>
                  <a class="navbar-item" target="_blank" href="https://github.com">GitHub</a>
                  <a class="navbar-item" target="_blank" href="https://jwt.io">JWT.io</a>                  
                  <a class="navbar-item" target="_blank" href="https://dotnet.microsoft.com">MS Docs</a>
              </div>
          </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="so2" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="index.html">Softwareontwerp 2</a></h3>
<ul class="nav-list">
      <li class="nav-item is-active" data-depth="0">
<ul class="nav-list">
      <li class="nav-item is-active" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Basis OO Ontwerp</span>
<ul class="nav-list">
      <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="01-klassen-objecten.html">Klassen &amp; Objecten</a>
  </li>
      <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="02-DCD-Overerving.html">DCD &amp; Overerving</a>
  </li>
      <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="03-RDD-GRASP.html">GRASP &amp; SSD</a>
  </li>
</ul>
  </li>
      <li class="nav-item is-active" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">MonoGame</span>
<ul class="nav-list">
      <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="10-monogame-basics.html">Basis</a>
  </li>
      <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="11-monogame-statemachine.html">State Machine</a>
  </li>
      <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="12-monogame-more_oo.html">Objectgeoriënteerd</a>
  </li>
</ul>
  </li>
      <li class="nav-item is-active" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">MAUI</span>
<ul class="nav-list">
      <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="20-maui_basics.html">Basis</a>
  </li>
      <li class="nav-item is-active is-current-page" data-depth="2">
    <a class="nav-link" href="21-maui_ioc-di.html">IoC &amp; DI</a>
  </li>
      <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="22-maui_mvvm.html">MVVM &amp; Navigatie</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Softwareontwerp 2</span>
    <span class="version"></span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <div class="title"><a href="index.html">Softwareontwerp 2</a></div>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Softwareontwerp 2</a></li>
    <li>MAUI</li>
    <li><a href="21-maui_ioc-di.html">IoC &amp; DI</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Maui - Inversion of Control &amp; Dependency Injection</h1>
<div class="sect1">
<h2 id="_inversion_of_control_ioc"><a class="anchor" href="#_inversion_of_control_ioc"></a>Inversion of Control (IoC)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Inversion of Control (IoC) is een ontwerppatroon dat bepaalt wie de "controle" heeft over de flow van een programma.
In traditionele code beslist de ontwikkelaar zelf wat er gebeurt: welke objecten worden aangemaakt, wanneer ze gebruikt worden, en hoe ze samenwerken. Bij IoC wordt die controle gedeeltelijk uit handen gegeven.</p>
</div>
<div class="sect2">
<h3 id="_klassiek_voorbeeld"><a class="anchor" href="#_klassiek_voorbeeld"></a>Klassiek voorbeeld</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">var service = new JokeService();
service.AddJoke("Er zijn 10 soorten mensen. Degenen die binair begrijpen en degenen die dat niet doen.");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Met als <code>JokeService</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">public class JokeService
{
    private readonly JokeRepository _jokeRepository = new JokeRepository();

    public void AddJoke(string joke)
    {
        ArgumentNullException.ThrowIfNullOrEmpty(joke);

        if (!JokeRespository.Exists(joke))
            _jokeRepository.Add(name);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Dit ontwerp is op het eerste gezicht goed gestructureerd: verschillende klassen hebben hun eigen verantwoordelijkheid, we hebben een <code>JokeService</code> die de logica bevat om een nieuwe grap op te slaan, en een <code>JokeRepository</code> dat instaat voor de persistentie.</p>
</div>
</div>
<div class="sect2">
<h3 id="_het_probleem"><a class="anchor" href="#_het_probleem"></a>Het probleem</h3>
<div class="paragraph">
<p>De <code>JokeService</code> beslist zelf <strong>welke</strong> repository ze gebruikt en <strong>wanneer</strong> die wordt aangemaakt. Dat betekent dat <code>JokeService</code> een sterke afhankelijkheid heeft van een specifieke implementatie (<code>JokeRepository</code>). Dit beperkt onze flexibiliteit.</p>
</div>
</div>
<div class="sect2">
<h3 id="_een_oplossing"><a class="anchor" href="#_een_oplossing"></a>Een oplossing</h3>
<div class="paragraph">
<p>Zou het niet handiger zijn als de <code>JokeService</code> eenvoudigweg een repository <strong>ontvangt</strong> in plaats van er zelf een te maken?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">public class JokeService
{
    private readonly IJokeRepository _jokeRepository = new JokeRepository();

    public JokeService(IJokeRepository jokeRepository)
    {
        _jokeRepository = jokeRepository;
    }

    public void AddJoke(string joke)
    {
        ArgumentNullException.ThrowIfNullOrEmpty(joke);

        if (!JokeRespository.Exists(joke))
            _jokeRepository.Add(name);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_voordelen"><a class="anchor" href="#_voordelen"></a>Voordelen</h3>
<div class="paragraph">
<p>Op deze manier is het aan de <strong>aanroeper</strong> van <code>JokeService</code> om een geldige implementatie van <code>IJokeRepository</code> te voorzien.
Dat heeft verschillende voordelen:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We kunnen tijdens <strong>unit tests</strong> eenvoudig een <strong>mock</strong> of <strong>fake</strong> implementatie van <code>IJokeRepository</code> gebruiken.</p>
</li>
<li>
<p>Verschillende klassen kunnen <strong>dezelfde</strong> instantie van <code>IJokeRepository</code> delen, wat bijvoorbeeld caching ten goede komt.</p>
</li>
<li>
<p>De code is <strong>losser gekoppeld</strong>: <code>JokeService</code> kent enkel de interface, niet de concrete implementatie.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_samenvatting"><a class="anchor" href="#_samenvatting"></a>Samenvatting</h3>
<div class="paragraph">
<p>Door het aanmaken van afhankelijkheden te verplaatsen naar een extern systeem (de aanroeper), geven we de controle deels uit handen — dat is de kern van <strong>Inversion of Control</strong>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dependency_injection_di"><a class="anchor" href="#_dependency_injection_di"></a>Dependency Injection (DI)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Dependency Injection (DI) is een concrete manier om Inversion of Control te realiseren.
In plaats van dat een klasse haar dependencies maakt, krijgt ze die van buitenaf mee.
De omgeving die deze objecten aanmaakt en bij elkaar brengt noemen we een container.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">var repo = new JokeRepository();
var service = new JokeService(repo);</code></pre>
</div>
</div>
<div class="paragraph">
<p>De aanroeper bepaalt wat er wordt geïnjecteerd.
De klasse zelf blijft vrij van harde koppelingen, waardoor ze testbaar, uitbreidbaar en duidelijker wordt.</p>
</div>
<div class="paragraph">
<p>DI is dus geen doel op zich, maar een techniek om Inversion of Control correct toe te passen.</p>
</div>
<div class="paragraph">
<p>MAUI bevat een ingebouwde DI-container. We hoeven zelf geen container te schrijven, en we hoeven ook niet elk object manueel door te geven.
MauiProgram.cs biedt een centrale plaats waar we services kunnen registreren, waarna MAUI ze automatisch aanmaakt en injecteert.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_registratie"><a class="anchor" href="#_registratie"></a>Registratie</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In MauiProgram.cs registreren we onze services.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">public static class MauiProgram
{
    public static MauiApp CreateMauiApp()
    {
        var builder = MauiApp.CreateBuilder();

        builder.UseMauiApp&lt;App&gt;();

        builder.Services.AddTransient&lt;JokeService&gt;();
        //builder.Services.AddSingleton&lt;JokeService&gt;();
        //builder.Services.AddScoped&lt;JokeService&gt;();

        return builder.Build();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We vertellen hiermee aan MAUI welke klassen het moet beheren. Vanaf dan wordt JokeService centraal aangemaakt, en overal waar het nodig is automatisch meegegeven.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<strong>AddTransient</strong>: Er wordt telkens een nieuwe instantie aangemaakt wanneer de service wordt opgevraagd.<br>
<strong>AddSingleton</strong>: Er wordt één enkele instantie aangemaakt voor de volledige duur van de applicatie. Iedereen die deze service opvraagt, krijgt dezelfde instantie.<br>
<strong>AddScoped</strong>: Er wordt één instantie aangemaakt per "scope". In MAUI speelt dit geen rol, omdat MAUI (in tegenstelling tot ASP.NET) geen natuurlijke scopes heeft zoals een web request. In webontwikkeling betekent dit: één instantie per http-request.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_injectie"><a class="anchor" href="#_injectie"></a>Injectie</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Wanneer MAUI een pagina maakt, onderzoekt het welke constructorparameters nodig zijn.
Vindt het een JokeService, dan haalt het die uit de container en geeft hem mee.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">public partial class MainPage : ContentPage
{
    private readonly JokeService _service;

    public MainPage(JokeService service)
    {
        InitializeComponent();
        _service = service;
    }

    private void Button_Clicked(object sender, EventArgs e)
    {
        var joke = _service.GetRandomJoke();
        outputLabel.Text = joke;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hier wordt duidelijk hoe MAUI Inversion of Control toepast:
niet de pagina beslist welke JokeService gebruikt wordt, maar MAUI bepaalt wat er wordt ingeïnjecteerd.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_oefening"><a class="anchor" href="#_oefening"></a>Oefening</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In de oefening van vorige week maakten we een aparte klasse die verantwoordelijk is voor de grappen. Refactor nu de oefening van vorige week zodat deze aparte klasse via DI gebruikt wordt.</p>
</div>
<div class="paragraph">
<p>We gaan  onze JokeService zelf ook gebruik laten maken van een andere component:  een repository. Deze zal dan persistentie doen of - zoals in ons geval - de lijst bijhouden in het geheugen. Op die manier wordt het ontwerp nog flexibeler en blijft elke verantwoordelijkheid netjes gescheiden.</p>
</div>
<div class="paragraph">
<p>We kunnen nu ook een DadJokeRepository toevoegen die dezelfde interface implementeert. Door deze repository te registreren in onze DI-container in plaats van de bestaande JokeRepository, schakelt de applicatie probleemloos over naar een andere bron van grappen, zonder dat we elders code moeten aanpassen.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_repository_en_data_opslag_met_litedb"><a class="anchor" href="#_repository_en_data_opslag_met_litedb"></a>Repository en data-opslag met LiteDB</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Tot nu toe hebben we DI gebruikt om services zoals JokeService in te pluggen.
We kunnen hetzelfde principe toepassen voor data-opslag, via een Repository en een database zoals LiteDB.</p>
</div>
<div class="paragraph">
<p><a href="https://www.litedb.org/">LiteDB</a> is een eenvoudige <a href="https://en.wikipedia.org/wiki/NoSQL">NoSQL-database</a> in één enkel bestand.
Je kan er rechtstreeks C#-objecten in bewaren zonder tabellen of SQL te definiëren.</p>
</div>
<div class="sect2">
<h3 id="_litedb_implementatie_van_de_repository"><a class="anchor" href="#_litedb_implementatie_van_de_repository"></a>LiteDB-implementatie van de repository</h3>
<div class="paragraph">
<p>We gaan nu een implementatie maken die LiteDB gebruikt.
Je voegt ondersteuning toe voor LiteDB via NuGet in je MAUI-project.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">using HoGentMauiBL.Interfaces;
using LiteDB;

namespace MauiJokesDL
{
    public class LiteDBJokeRepository : IJokeRespository, IDisposable
    {
        private const string DATABASE_LOCATION = "joke_db.db";

        // Een 'record' een zeer eenvoudige manier om een data klasse te maken
        public record Joke(string Text);

        // De database connectie, dewelke we pas willen creëeren als we die gebruiken. Vandaar de 'Lazy' klasse.
        private static Lazy&lt;LiteDatabase&gt; _database = new Lazy&lt;LiteDatabase&gt;(new LiteDatabase(DATABASE_LOCATION));

        // We moeten altijd via een 'Collection' gaan, je kan dit vergelijken met een Table in gewone SQL databases
        private ILiteCollection&lt;Joke&gt; JokeCollection
            =&gt; _database.Value.GetCollection&lt;Joke&gt;();

        public void Add(string joke)
            =&gt; JokeCollection.Insert(new Joke(joke));


        public bool Exists(string joke)
            =&gt; JokeCollection.Exists(x =&gt; x.Text == joke);

        public string Get(int jokeIndex)
        {
            // We willen een 'joke' vinden op index, hiervoor moeten we de tabel sorteren en dan de waarde pakken bij de index
            return JokeCollection.Query()               // Start een query
                                 .OrderBy(x =&gt; x.Text)  // Kies een sortering
                                 .Offset(jokeIndex)     // Sla 'jokeIndex' aantal over
                                 .Limit(1)              // Neem 1 record
                                 .FirstOrDefault()?     // Uit de resulteren lijst, pak de eerst (er zal maar 1 zijn door de Limit)
                                 .Text                  // Neem hiervan de Text property
                                 ?? "";                 // Als we 'null' krijgen, geen een lege string terug
        }

        public int GetCount()
            =&gt; JokeCollection.Count();

        public void Dispose()
        {
            // We moeten de database connectie sluiten als ons object vernietigd wordt.
            if (_database.IsValueCreated)
                _database.Value.Dispose();
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_registratie_in_mauiprogram"><a class="anchor" href="#_registratie_in_mauiprogram"></a>Registratie in MauiProgram</h3>
<div class="paragraph">
<p>We koppelen alles opnieuw via de DI-container in MauiProgram.cs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">public static class MauiProgram
{
    public static MauiApp CreateMauiApp()
    {
        var builder = MauiApp.CreateBuilder();

        ...

        // We registreren via 'Singleton' omdat we willen vermijden dat we een nieuwe connectie krijgen per keer we de JokeRepository opvragen
        builder.Services.AddSingleton&lt;IJokeRespository, LiteDBJokeRepository&gt;();
        //builder.Services.AddTransient&lt;IJokeRespository, JokeRepository&gt;();

        // JokeService gebruikt de repository via de interface
        builder.Services.AddTransient&lt;JokeService&gt;();

        ...

        return builder.Build();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note: LiteDbJokeRepository willen we als Singleton, want anders gaan we verschillende connecties openen naar onze LiteDb.
* kan JokeService via DI met de repository werken,
* en heeft de UI geen idee meer dat LiteDB bestaat.</p>
</div>
</div>
<div class="sect2">
<h3 id="_gebruik_in_de_maui_pagina"><a class="anchor" href="#_gebruik_in_de_maui_pagina"></a>Gebruik in de MAUI-pagina</h3>
<div class="paragraph">
<p>Voor de pagina verandert er niets: we injecteren nog altijd JokeService, maar die werkt nu met een echte database.</p>
</div>
</div>
<div class="sect2">
<h3 id="_oefening_2"><a class="anchor" href="#_oefening_2"></a>Oefening</h3>
<div class="paragraph">
<p>Als de gebruiker de willekeurig getoonde grap niet leuk vind dan moet hij deze kunnen verwijderen. Hiervoor voeg je een knop toe aan het bovenste deel van het scherm. Wanneer hierop geklikt wordt dan zal hij, via de JokeService, de grap verwijderen. Dit moet zowel werken voor de JokeRepository, als voor de LiteDBJokeRepository. Aan de bestaande interface methoden wijzigt er niks, je voegt gewoon 1 extra toe.</p>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using a customized version of the Antora default UI.</p>
  <p>The source code for the default UI is licensed under the terms of the MPL-2.0 license.</p>
    <p>Content by Stefan Courteaux unless otherwise noted. </p>
</footer>
<script id="site-script" src="../_/js/site.js" data-ui-root-path="../_"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
